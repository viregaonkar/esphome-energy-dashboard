# Animationen und Updates

# Updates
interval:
  - interval: 1s
    then:
      - lvgl.label.update:
          id: pv_value
          text: !lambda |-
            if (id(solar_power).has_state() && !isnan(id(solar_power).state)) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.2f", id(solar_power).state);
              return buf;
            }
            return "0.00";
      
      - lvgl.label.update:
          id: grid_bezug_label
          text: !lambda |-
            if (id(grid_power).has_state() && !isnan(id(grid_power).state)) {
              static char buf[20];
              snprintf(buf, sizeof(buf), "%6.2f kWh", id(grid_power).state);
              return buf;
            }
            return "  0.00 kWh";
      
      - lvgl.label.update:
          id: grid_einspeisung_label
          text: !lambda |-
            if (id(grid_feed_in).has_state() && !isnan(id(grid_feed_in).state)) {
              static char buf[20];
              snprintf(buf, sizeof(buf), "%6.2f kWh", id(grid_feed_in).state);
              return buf;
            }
            return "  0.00 kWh";
      
      - lvgl.label.update:
          id: home_value
          text: !lambda |-
            if (id(home_power).has_state() && !isnan(id(home_power).state)) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.2f", id(home_power).state);
              return buf;
            }
            return "0.00";
      
      - lvgl.label.update:
          id: battery_charge_label
          text: !lambda |-
            if (id(battery_charge).has_state() && !isnan(id(battery_charge).state)) {
              static char buf[20];
              snprintf(buf, sizeof(buf), "%.2f kWh", id(battery_charge).state);
              return buf;
            }
            return "0.00 kWh";
      
      - lvgl.label.update:
          id: battery_discharge_label
          text: !lambda |-
            if (id(battery_discharge).has_state() && !isnan(id(battery_discharge).state)) {
              static char buf[20];
              snprintf(buf, sizeof(buf), "%.2f kWh", id(battery_discharge).state);
              return buf;
            }
            return "0.00 kWh";
      
      - lvgl.arc.update:
          id: battery_arc
          value: !lambda |-
            if (id(battery_soc).has_state() && !isnan(id(battery_soc).state)) {
              return (int)id(battery_soc).state;
            }
            return 0;
      
      - lvgl.label.update:
          id: battery_soc_label
          text: !lambda |-
            if (id(battery_soc).has_state() && !isnan(id(battery_soc).state)) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%d%%", (int)id(battery_soc).state);
              return buf;
            }
            return "0%";
      
      - lvgl.label.update:
          id: gas_value
          text: !lambda |-
            if (id(gas_power).has_state() && !isnan(id(gas_power).state)) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.2f", id(gas_power).state);
              return buf;
            }
            return "0.00";
      
      - lvgl.label.update:
          id: water_value
          text: !lambda |-
            if (id(water_power).has_state() && !isnan(id(water_power).state)) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.2f", id(water_power).state);
              return buf;
            }
            return "0.00";

  # Animation - animierte Segmente entlang der Kurven
  - interval: 30ms
    then:
      - lambda: |-
          static int pv_pos = 0;
          static int grid_pos = 0;
          static int battery_pos = 0;
          static int gas_pos = 0;
          static int water_pos = 0;
          
          // PV Flow (eckig: vertikal runter, dann horizontal rechts ins Haus)
          // Nur animieren wenn PV-Leistung > 0
          bool show_pv_home = false;
          if (id(solar_power).has_state() && !isnan(id(solar_power).state)) {
            show_pv_home = id(solar_power).state > 0.0;
          }
          
          if (show_pv_home) {
            lv_obj_clear_flag(id(flow_pv), LV_OBJ_FLAG_HIDDEN);
            pv_pos = (pv_pos + 2) % 215;
            if (pv_pos < 75) {
              // Vertikal nach unten
              lv_obj_set_x(id(flow_pv), 258);
              lv_obj_set_y(id(flow_pv), 130 + pv_pos);
              lv_obj_set_width(id(flow_pv), 4);
              lv_obj_set_height(id(flow_pv), 15);
            } else {
              // Horizontal nach rechts ins Haus
              int c = pv_pos - 75;
              lv_obj_set_x(id(flow_pv), 260 + c);
              lv_obj_set_y(id(flow_pv), 218);
              lv_obj_set_width(id(flow_pv), 15);
              lv_obj_set_height(id(flow_pv), 4);
            }
          } else {
            lv_obj_add_flag(id(flow_pv), LV_OBJ_FLAG_HIDDEN);
          }
          
          // Grid Flow (horizontal zu Home)
          // Nur animieren wenn Netzbezug > 0
          bool show_grid_home = false;
          if (id(grid_power).has_state() && !isnan(id(grid_power).state)) {
            show_grid_home = id(grid_power).state > 0.0;
          }
          
          if (show_grid_home) {
            lv_obj_clear_flag(id(flow_grid), LV_OBJ_FLAG_HIDDEN);
            grid_pos = (grid_pos + 3) % 270;
            lv_obj_set_x(id(flow_grid), 130 + grid_pos);
            lv_obj_set_y(id(flow_grid), 238);
            lv_obj_set_width(id(flow_grid), 15);
            lv_obj_set_height(id(flow_grid), 4);
          } else {
            lv_obj_add_flag(id(flow_grid), LV_OBJ_FLAG_HIDDEN);
          }
          
          // Battery Flow (eckig: vertikal hoch, dann horizontal rechts ins Haus)
          // Nur animieren wenn Batterieentladung > 0
          bool show_battery_discharge = false;
          if (id(battery_discharge).has_state() && !isnan(id(battery_discharge).state)) {
            show_battery_discharge = id(battery_discharge).state > 0.0;
          }
          
          if (show_battery_discharge) {
            lv_obj_clear_flag(id(flow_battery), LV_OBJ_FLAG_HIDDEN);
            battery_pos = (battery_pos + 2) % 215;
            if (battery_pos < 90) {
              // Vertikal nach oben
              lv_obj_set_x(id(flow_battery), 258);
              lv_obj_set_y(id(flow_battery), 350 - battery_pos);
              lv_obj_set_width(id(flow_battery), 4);
              lv_obj_set_height(id(flow_battery), 15);
            } else {
              // Horizontal nach rechts ins Haus
              int c = battery_pos - 90;
              lv_obj_set_x(id(flow_battery), 260 + c);
              lv_obj_set_y(id(flow_battery), 258);
              lv_obj_set_width(id(flow_battery), 15);
              lv_obj_set_height(id(flow_battery), 4);
            }
          } else {
            lv_obj_add_flag(id(flow_battery), LV_OBJ_FLAG_HIDDEN);
          }
          
          // Home Flow (horizontal innerhalb Home)
          lv_obj_set_x(id(flow_home), 360);
          lv_obj_set_y(id(flow_home), 238);
          
          // Gas Flow (vertikal nach unten zu Home)
          gas_pos = (gas_pos + 1) % 110;
          lv_obj_set_x(id(flow_gas), 398);
          lv_obj_set_y(id(flow_gas), 130 + gas_pos);
          lv_obj_set_width(id(flow_gas), 4);
          lv_obj_set_height(id(flow_gas), 15);
          
          // Water Flow (vertikal nach oben zu Home)
          water_pos = (water_pos + 1) % 110;
          lv_obj_set_x(id(flow_water), 398);
          lv_obj_set_y(id(flow_water), 350 - water_pos);
          lv_obj_set_width(id(flow_water), 4);
          lv_obj_set_height(id(flow_water), 15);
          
          // Grid -> Battery Flow (horizontal rechts bis Mitte, dann vertikal runter)
          static int grid_battery_pos = 0;
          grid_battery_pos = (grid_battery_pos + 2) % 215;
          if (grid_battery_pos < 75) {
            // Horizontal nach rechts
            lv_obj_set_x(id(flow_grid_battery), 130 + grid_battery_pos);
            lv_obj_set_y(id(flow_grid_battery), 258);
            lv_obj_set_width(id(flow_grid_battery), 15);
            lv_obj_set_height(id(flow_grid_battery), 4);
          } else {
            // Vertikal nach unten
            int c = grid_battery_pos - 75;
            lv_obj_set_x(id(flow_grid_battery), 218);
            lv_obj_set_y(id(flow_grid_battery), 260 + c);
            lv_obj_set_width(id(flow_grid_battery), 4);
            lv_obj_set_height(id(flow_grid_battery), 15);
          }
          
          // PV -> Grid Flow (vertikal runter bis Mitte, dann horizontal links)
          // Nur animieren wenn Einspeisung > 0
          bool show_pv_grid = false;
          if (id(grid_feed_in).has_state() && !isnan(id(grid_feed_in).state)) {
            show_pv_grid = id(grid_feed_in).state > 0.0;
          }
          
          if (show_pv_grid) {
            lv_obj_clear_flag(id(flow_pv_grid), LV_OBJ_FLAG_HIDDEN);
            static int pv_grid_pos = 0;
            pv_grid_pos = (pv_grid_pos + 2) % 215;
            if (pv_grid_pos < 75) {
              // Vertikal nach unten
              lv_obj_set_x(id(flow_pv_grid), 218);
              lv_obj_set_y(id(flow_pv_grid), 130 + pv_grid_pos);
              lv_obj_set_width(id(flow_pv_grid), 4);
              lv_obj_set_height(id(flow_pv_grid), 15);
            } else {
              // Horizontal nach links
              int c = pv_grid_pos - 75;
              lv_obj_set_x(id(flow_pv_grid), 203 - c);
              lv_obj_set_y(id(flow_pv_grid), 218);
              lv_obj_set_width(id(flow_pv_grid), 15);
              lv_obj_set_height(id(flow_pv_grid), 4);
            }
          } else {
            lv_obj_add_flag(id(flow_pv_grid), LV_OBJ_FLAG_HIDDEN);
          }
          
          // PV -> Battery Flow (vertikal mittig runter)
          // Nur animieren wenn Batterieladung > 0
          bool show_pv_battery = false;
          if (id(battery_charge).has_state() && !isnan(id(battery_charge).state)) {
            show_pv_battery = id(battery_charge).state > 0.0;
          }
          
          if (show_pv_battery) {
            lv_obj_clear_flag(id(flow_pv_battery), LV_OBJ_FLAG_HIDDEN);
            static int pv_battery_pos = 0;
            pv_battery_pos = (pv_battery_pos + 2) % 270;
            lv_obj_set_x(id(flow_pv_battery), 238);
            lv_obj_set_y(id(flow_pv_battery), 130 + pv_battery_pos);
            lv_obj_set_width(id(flow_pv_battery), 4);
            lv_obj_set_height(id(flow_pv_battery), 15);
          } else {
            lv_obj_add_flag(id(flow_pv_battery), LV_OBJ_FLAG_HIDDEN);
          }
